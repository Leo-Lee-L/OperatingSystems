<!DOCTYPE html>
<html>
    <head>
        <link href="style.css" rel="stylesheet" type="text/css"/>
        <title>
             Case Study: VMware
        </title>
    </head>

    <body>
    <div id="header">
        <div id="logo">
            <img
            src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/IBM_PPC604e_200.jpg/220px-IBM_PPC604e_200.jpg"
            height="56" width="56"
            max-height=100%>
        </div>
        <div id="user-tools">
            <a href="index.html">Home</a>
            &nbsp; &nbsp; 
            <a href="about.html">About</a>
        </div>
    </div>

        <h1>
             Case Study: VMware
        </h1>

            <figure>
                <img src="graphics/vSphere.png">
                <figcaption>
                VMware vSphere (see credits)
                </figcaption>
            </figure>

            <details>
                <summary class="sum1">
                    The Early History of VMware
                </summary>
    
                <ul>
                    <li>
                        Based on work at Stanford in the late 1990s.
                    </li>
                    <li>
                        The founders realized that rather than solving existing
                        problems in large, complex, operating systems, one
                        could innovate in a layer below the OS.
                    </li>
                    <li>
                        <b>1998:</b>
                    </li>
                    <ul>
                        <li>
                            <b>VMware Workstation for Linux</b>
                            <br />
                            Ran on top of Linux.
                        </li>
                        <li>
                            <b>VMware Workstation for Windows</b>
                            <br />
                            Ran on top of Windows.
                        </li>
                    </ul>
                    <li>
                        <b>2001: ESX Server</b>
                        <ul>
                            <li>
                                Aimed at the server consolidation market.
                            </li>
                            <li>
                                Prior practice: buy a server for each email,
                                web, DB server application.
                            </li>
                            <li>
                                Machines were often at 10% capacity!
                            </li>
                        </ul>
                    </li>
                    <li>
                        <b>2002: Virtual Center / vSphere</b>:
                        <br />
                        Manage 1000s of virtual machines from one application.
                    </li>
                    <li>
                        <b>VMotion</b>:
                        <br />
                        Live migrate servers.
                    </li>
                    <figure>
                        <iframe width="560" height="315"
                            src="https://www.youtube.com/embed/9f5GFB0m_E4"
                            frameborder="0" allowfullscreen>
                        </iframe>
                        <figcaption>
                            Live migrating a server from Raleigh to Amsterdam.
                        </figcaption>
                    </figure>
                </ul>

            </details>

            <details>
                <summary class="sum1">
                    VMware Workstation
                </summary>
   
                <ul>
                    <li>
                        The first virtualization product for 32-bit x86.
                    </li>
                    <li>
                        The "WinTel" platform was very different from
                        vertically integrated mainframes:
                        <ol type="a">
                            <li>
                                Intel and AMD build the chips.
                            </li>
                            <li>
                                Microsoft (Windows) and open source (Linux)
                                provide the OS.
                            </li>
                            <li>
                                A third group of companies build peripherals.
                            </li>
                            <li>
                                A fourth group of integrators (Dell, HP) build
                                systems for retail sale.
                            </li>
                        </ol>
                    </li>
                    <li>
                        What's more, there was no hardware support for
                        virtualization.
                    </li>
                    <li>
                        So VMware had to use existing techniques of
                        virtualization, borrow techniques from other areas, and
                        invent some.
                    </li>
                </ul>

                <details>
                    <summary class="sum2">
                        Video: What Is VMware Workstation?
                    </summary>
                    <figure>
                        <iframe width="560" height="315"
                            src="https://www.youtube.com/embed/_GVZHuHHdnk"
                            frameborder="0" allowfullscreen>
                        </iframe>
                        <figcaption>
                            A video on VMware Workstation
                        </figcaption>
                    </figure>
                </details>

            </details>

            <details>
                <summary class="sum1">
                    Challenges in Bringing Virtualization to the x86
                </summary>
    
                <p>
                    Hypervisors <b>add a level of indirection</b> to the domain
                    of computer hardware. They provide the abstraction of a
                    <b>virtual machine</b>: each one thinks if is "king of the
                    hill," and has a whole machine to itself. Ideally, the VMs
                    should be just like the emulated machine, as fast as the
                    emulated machine, and completely isolated from each other.
                    <br />
                    VMware had these goals (general to most virtualization):
                </p>

                <ol>
                    <li>
                        <b>Compatibility:</b>
                        <br />
                        Any x86 OS, and all of its applications, should be able
                        to run on without modifications on the VM.
                    </li>
                    <li>
                        <b>Performance:</b>
                        <br />
                        The overhead of the hypervisor had to be low enough the
                        users could use a VM as their primary machine.
                        <br />
                        Ideally, things run as fast as on a native OS, but at
                        least as fast as the previous chip generation.
                    </li>
                    <li>
                        <b>Isolation:</b>
                        <br />
                        The hypervisor had to ensure complete isolation of each
                        VM, i.e., be completely in charge of the real physical
                        resources. A VM might be infected with malicious code:
                        this will not impact any other VM.
                    </li>
                </ol>

                <p>
                    There was tension between the requirements. E.g., total
                    compatibility might need to be sacrificed for performance.
                    But the designers held isolation as paramount.
                    <br />
                    The primary challenges were:
                </p>

                <ol>
                    <li>
                        <b>The x86 architecture did not support virtualization.</b>
                        <br />
                    </li>
                    <li>
                        <b>The x86 architecture was of daunting complexity.</b>
                        <br />
                        Decades of "cruft" built up due to backwards
                        compatibility goal. Four modes: real, protected, v8086,
                        and 
                        <a
                            href="https://en.wikipedia.org/wiki/System_Management_Mode">
                            system management</a>.
                        <br />
                        <a
                            href="https://en.wikipedia.org/wiki/X86#Operating_modes">
                            x86 operating modes.
                        </a>
                    </li>
                    <li>
                        <b>x86 machines had diverse peripherals.</b>
                        <br />
                    </li>
                    <li>
                        <b>The need for a simple user experience.</b>
                        <br />
                        The users would be doing the installs themselves, not
                        (e.g.) an IBM technician.
                    </li>
                </ol>

            </details>

            <details>
                <summary class="sum1">
                    VMware Workstation: Solution Overview
                </summary>
    
                <details>
                    <summary class="sum2">
                        Virtualizing the x86 Architecture
                    </summary>

                    <ul>
                        <li>
                            <b>VMM:</b> runs the actual virtual machine.
                        </li>
                        <li>
                            <b>VMX:</b> interacts with host OS.
                        </li>
                    </ul>

                    <p>
                        Possible approaches:
                    </p>

                    <ul>
                        <li>
                            Rely on hardware support for virtualization to
                            <b>trap-and-emulte</b> "dangerous" instructions.
                        </li>
                    </ul>

                    <p>
                        Binary translation must be used if:
                    </p>

                    <ol>
                        <li>
                            The virtual machine is running in kernel mode (ring
                            0).
                        </li>
                        <li>
                            The virtual machine can disable interrupts and
                            issue I/O instructions.
                        </li>
                        <li>
                            The virtual machine is running in real mode, a
                            legacy 16-bit mode used by BIOS.
                        </li>
                    </ol>
        
                    <figure>
                        <img src="graphics/07-08.png"
                            width="440"
                            height="210">
                        <figcaption>
                        High-level components of the VMware virtual machine
                        monitor.
                        </figcaption>
                    </figure>
                </details>
    
                <details>
                    <summary class="sum2">
                        A Guest Operating System Centric Strategy
                    </summary>
        
                </details>
    
                <details>
                    <summary class="sum2">
                        The Virtual Hardware Platform
                    </summary>
        
                    <figure>
                        <img src="graphics/07-09.png">
                        <figcaption>
                        Virtual hardware configuration of VMware
                        workstation in 2000.
                        </figcaption>
                    </figure>
                </details>
    
                <details>
                    <summary class="sum2">
                        The Role of the Host Operating System
                    </summary>
        
                    <figure>
                        <img src="graphics/07-10.png"
                            width="440"
                            height="250">
                        <figcaption>
                        The VMware Hosted Architecture
                        </figcaption>
                    </figure>

                    <figure>
                        <img src="graphics/07-11.png"
                            width="440"
                            height="192">
                        <figcaption>
                        The difference between a normal context switch and a
                        world switch.
                        </figcaption>
                    </figure>
                </details>
            </details>

            <details>
                <summary class="sum1">
                    The Evolution of the VMware Workstation
                </summary>
    
            </details>

            <details>
                <summary class="sum1">
                    ESX Server: VMware's type 1 Hypervisor
                </summary>

                    <figure>
                            <img src="graphics/07-12.png"
                                width="440"
                                height="182">
                            <figcaption>
                            ESX Server
                            </figcaption>
                    </figure>
    
                    <ol>
                        <li>
                            The CPU scheduler ensures that each virtual machine
                            gets a fair share of the CPU: no starvation.
                        </li>
                        <li>
                            Scalability: VMs run efficiently even when they
                            need more memory than is actually available.
                            <br />
                            <b>Ballooning</b> and <b>transparent page
                                sharing</b> introduced.
                        </li>
                        <li>
                            An optimized I/O subsystem: device drivers run
                            directly within the ESX hypervisor, with no world
                            switch required.
                        </li>
                        <li>
                            ESX uses a file system (VMFS) optimized to store
                            virtual machine images. A single ESX Server can
                            issue over 1 million disk operations per second.
                        </li>
                        <li>
                            The workstations were aimed at developers: one
                            could experiment with new OS releases inside a VM.
                        </li>
                        <li>
                            ESX Server made it easy to implement new
                            capabilities.
                        </li>
                        <li>
                            <b>VMotion:</b>
                            live migrate a VM from one box running
                            ESX Server to another. This required the
                            coordination of the memory manager, the CPU
                            scheduler, and the networking stack.
                        </li>
                    </ol>
            </details>

            <details>
                <summary class="sum1">
                    Video on Building a VMware Home Lab
                </summary>
                <figure>
                    <iframe width="560" height="315"
                        src="https://www.youtube.com/embed/Hm7kQHI4YnM"
                        frameborder="0" allowfullscreen></iframe>
                    <figcaption>
                    VMware home lab
                    </figcaption>
                </figure>
            </details>

    <details>
        <summary class="sum1">
            Quiz
        </summary>
        <ol>
            <li>
                A key attribute of an ideal virtual machine would be
            </li>
            <ol type="a">
                <li>
                <input type="radio" name="q1" value="new">
                it runs as fast as the real machine
                </li>
                <li>
                <input type="radio" name="q1" value="new">
                it runs just like the real machine
                </li>
                <li>
                <input type="radio" name="q1" value="new">
                it is completely isolated from other VMs
                </li>
                <li>
                <input type="radio" name="q1" value="new">
                all of the above.
                </li>
            </ol>
            <li>
                Live migrating a VM between physical devices requires coordination of
            </li>
            <ol type="a">
                <li>
                <input type="radio" name="q2" value="new">
                the file system and the stack pointer
                </li>
                <li>
                <input type="radio" name="q2" value="new">
                the CPU scheduler the memory manager and the network stack
                </li>
                <li>
                <input type="radio" name="q2" value="new">
                the RAID array
                </li>
                <li>
                <input type="radio" name="q2" value="new">
                the number of applications running on each VM.
                </li>
            </ol>
            <li>
                A motivation for VMware was
            </li>
            <ol type="a">
                <li>
                <input type="radio" name="q3" value="new">
                the desire to copy IBM
                </li>
                <li>
                <input type="radio" name="q3" value="new">
                the need for a research grant
                </li>
                <li>
                <input type="radio" name="q3" value="new">
                the fact that no one had ever created a VM before
                </li>
                <li>
                <input type="radio" name="q3" value="new">
                the difficulty in innovating in complex modern operatings systems.
                </li>
            </ol>
            <li>
                One factor making VMs easier to implement on mainframes than on PCs was
            </li>
            <ol type="a">
                <li>
                <input type="radio" name="q4" value="new">
                vertical integration in the mainframe world
                </li>
                <li>
                <input type="radio" name="q4" value="new">
                Microsoft's opposition to virtualization
                </li>
                <li>
                <input type="radio" name="q4" value="new">
                the complexity of mainframe design
                </li>
                <li>
                <input type="radio" name="q4" value="new">
                the lack of UNIX versions on PCs
                </li>
            </ol>
            <li>
                Another factor making virtualization difficult on the WinTel platform was
            </li>
            <ol type="a">
                <li>
                <input type="radio" name="q5" value="new">
                the overly simple chip architecture
                </li>
                <li>
                <input type="radio" name="q5" value="new">
                the amazing diversity of peripherals
                </li>
                <li>
                <input type="radio" name="q5" value="new">
                the competition from IBM
                </li>
                <li>
                <input type="radio" name="q5" value="new">
                all of the above
                </li>
            </ol>
            <li>
                A virtualization approach called "trap-and-emulate" involves
            </li>
            <ol type="a">
                <li>
                <input type="radio" name="q6" value="new">
                a switch to the hypervisor when certain instructions are executed by the VM
                </li>
                <li>
                <input type="radio" name="q6" value="new">
                faking the guest into "thinking" is has really executed certain instructions
                </li>
                <li>
                <input type="radio" name="q6" value="new">
                allowing most instructions to run directly on the hardware
                </li>
                <li>
                <input type="radio" name="q6" value="new">
                all of the above
                </li>
            </ol>
        </ol>
        <details>
            <summary class="sum2">
                Answers
            </summary>
            <p>
                1. d; 2. b; 3. d; 4. a; 5. b; 6. d; 
            </p>
        </details>
    </details>

            <details>
                <summary class="sum1">
                    Credits
                </summary>
                "VMware in the cloud" graphic by Hany R. Michael.
            </details>

        
    </body>
</html>
